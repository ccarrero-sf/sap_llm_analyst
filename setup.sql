use database SAP_LLM_ANALYST2;

use schema PUBLIC;

CREATE OR REPLACE STAGE SEMANTIC_MODELS
  DIRECTORY = (ENABLE = TRUE)
  ENCRYPTION = ( TYPE = 'SNOWFLAKE_SSE' );

COPY FILES
  INTO @SEMANTIC_MODELS
  FROM @SAP_LLM_ANALYST2.PUBLIC.GITHUB_REPO_SAP_LLM_ANALYST/branches/main/files/
  PATTERN='.*yaml';

ALTER STAGE SEMANTIC_MODELS REFRESH;

CREATE OR REPLACE SCHEMA SAP_RAW;

CREATE OR REPLACE STAGE CSV_FILES
  DIRECTORY = (ENABLE = TRUE)
  ENCRYPTION = ( TYPE = 'SNOWFLAKE_SSE' );

--- COPY FILES
COPY FILES
  INTO @CSV_FILES
  FROM @SAP_LLM_ANALYST2.PUBLIC.GITHUB_REPO_SAP_LLM_ANALYST/branches/main/files/
  PATTERN='.*[.]gz';
ALTER STAGE CSV_FILES REFRESH;

-- Create tables;

create or replace TABLE "0customer_attr" (
	MANDT VARCHAR(3),
	KUNNR VARCHAR(10),
	ADRNR VARCHAR(10),
	ANRED VARCHAR(15),
	AUFSD VARCHAR(2),
	BAHNE VARCHAR(25),
	BAHNS VARCHAR(25),
	BBBNR VARCHAR(7),
	BBSNR VARCHAR(5),
	BEGRU VARCHAR(4),
	BRSCH VARCHAR(4),
	BUBKZ VARCHAR(1),
	DATLT VARCHAR(14),
	ERDAT DATE,
	ERNAM VARCHAR(12),
	EXABL VARCHAR(1),
	FAKSD VARCHAR(2),
	FISKN VARCHAR(10),
	KNAZK VARCHAR(2),
	KNRZA VARCHAR(10),
	KONZS VARCHAR(10),
	KTOKD VARCHAR(4),
	KUKLA VARCHAR(2),
	LAND1 VARCHAR(3),
	LIFNR VARCHAR(10),
	LIFSD VARCHAR(2),
	LOCCO VARCHAR(10),
	LOEVM VARCHAR(1),
	NAME1 VARCHAR(35),
	NAME2 VARCHAR(35),
	NAME3 VARCHAR(35),
	NAME4 VARCHAR(35),
	NIELS VARCHAR(2),
	ORT01 VARCHAR(35),
	ORT02 VARCHAR(35),
	PFACH VARCHAR(10),
	PSTL2 VARCHAR(10),
	PSTLZ VARCHAR(10),
	REGIO VARCHAR(3),
	COUNC VARCHAR(3),
	CITYC VARCHAR(4),
	RPMKR VARCHAR(5),
	SORTL VARCHAR(10),
	SPERR VARCHAR(1),
	SPRAS VARCHAR(1),
	STCD1 VARCHAR(16),
	STCD2 VARCHAR(11),
	STKZA VARCHAR(1),
	STKZU VARCHAR(1),
	STRAS VARCHAR(35),
	TELBX VARCHAR(15),
	TELF1 VARCHAR(16),
	TELF2 VARCHAR(16),
	TELFX VARCHAR(31),
	TELTX VARCHAR(30),
	TELX1 VARCHAR(30),
	LZONE VARCHAR(10),
	XCPDK VARCHAR(1),
	XZEMP VARCHAR(1),
	VBUND VARCHAR(6),
	STCEG VARCHAR(20),
	DEAR1 VARCHAR(1),
	DEAR2 VARCHAR(1),
	DEAR3 VARCHAR(1),
	DEAR4 VARCHAR(1),
	DEAR5 VARCHAR(1),
	DEAR6 VARCHAR(1),
	GFORM VARCHAR(2),
	BRAN1 VARCHAR(10),
	BRAN2 VARCHAR(10),
	BRAN3 VARCHAR(10),
	BRAN4 VARCHAR(10),
	BRAN5 VARCHAR(10),
	EKONT VARCHAR(10),
	UMSAT FLOAT,
	UMJAH VARCHAR(4),
	UWAER VARCHAR(5),
	JMZAH VARCHAR(6),
	JMJAH VARCHAR(4),
	KATR1 VARCHAR(2),
	KATR2 VARCHAR(2),
	KATR3 VARCHAR(2),
	KATR4 VARCHAR(2),
	KATR5 VARCHAR(2),
	KATR6 VARCHAR(3),
	KATR7 VARCHAR(3),
	KATR8 VARCHAR(3),
	KATR9 VARCHAR(3),
	KATR10 VARCHAR(3),
	STKZN VARCHAR(1),
	UMSA1 FLOAT,
	TXJCD VARCHAR(15),
	MCOD1 VARCHAR(25),
	MCOD2 VARCHAR(25),
	MCOD3 VARCHAR(25),
	PERIV VARCHAR(2),
	ABRVW VARCHAR(3),
	INSPBYDEBI VARCHAR(1),
	INSPATDEBI VARCHAR(1),
	KTOCD VARCHAR(4),
	PFORT VARCHAR(35),
	WERKS VARCHAR(4),
	DTAMS VARCHAR(1),
	DTAWS VARCHAR(2),
	DUEFL VARCHAR(1),
	HZUOR VARCHAR(2),
	SPERZ VARCHAR(1),
	ETIKG VARCHAR(10),
	CIVVE VARCHAR(1),
	MILVE VARCHAR(1),
	KDKG1 VARCHAR(2),
	KDKG2 VARCHAR(2),
	KDKG3 VARCHAR(2),
	KDKG4 VARCHAR(2),
	KDKG5 VARCHAR(2),
	XKNZA VARCHAR(1),
	FITYP VARCHAR(2),
	STCDT VARCHAR(2),
	STCD3 VARCHAR(18),
	STCD4 VARCHAR(18),
	XICMS VARCHAR(1),
	XXIPI VARCHAR(1),
	XSUBT VARCHAR(3),
	CFOPC VARCHAR(2),
	TXLW1 VARCHAR(3),
	TXLW2 VARCHAR(3),
	CCC01 VARCHAR(1),
	CCC02 VARCHAR(1),
	CCC03 VARCHAR(1),
	CCC04 VARCHAR(1),
	CASSD VARCHAR(2),
	KNURL VARCHAR(132),
	"fullname" VARCHAR(100)
);


create or replace TABLE "0fi_ar_4" (
	BUKRS VARCHAR(4),
	FISCPER VARCHAR(7),
	BELNR VARCHAR(10),
	BUZEI VARCHAR(3),
	UPOSZ VARCHAR(4),
	STATUSPS VARCHAR(1),
	KUNNR VARCHAR(10),
	KKBER VARCHAR(4),
	MABER VARCHAR(2),
	KOART VARCHAR(1),
	UMSKZ VARCHAR(1),
	BLART VARCHAR(2),
	BSCHL VARCHAR(2),
	FISCVAR VARCHAR(2),
	BLDAT DATE,
	BUDAT DATE,
	CPUDT DATE,
	AUGDT DATE,
	MADAT DATE,
	NETDT DATE,
	SK1DT DATE,
	SK2DT DATE,
	ZFBDT DATE,
	ZBD1T FLOAT,
	ZBD2T FLOAT,
	ZBD3T FLOAT,
	ZBD1P FLOAT,
	ZBD2P FLOAT,
	LAND1 VARCHAR(3),
	ZLSCH VARCHAR(1),
	ZTERM VARCHAR(4),
	ZLSPR VARCHAR(1),
	RSTGR VARCHAR(3),
	MANSP VARCHAR(1),
	MSCHL VARCHAR(1),
	MANST VARCHAR(1),
	LCURR VARCHAR(5),
	DMSOL FLOAT,
	DMHAB FLOAT,
	DMSHB FLOAT,
	SKNTO FLOAT,
	WAERS VARCHAR(5),
	WRSOL FLOAT,
	WRHAB FLOAT,
	WRSHB FLOAT,
	SKFBT FLOAT,
	WSKTO FLOAT,
	KTOPL VARCHAR(4),
	HKONT VARCHAR(10),
	SAKNR VARCHAR(10),
	FILKD VARCHAR(10),
	AUGBL VARCHAR(10),
	XBLNR VARCHAR(16),
	REBZG VARCHAR(10),
	REBZJ VARCHAR(4),
	REBZZ VARCHAR(3),
	VBELN VARCHAR(10),
	XREF1 VARCHAR(12),
	XREF2 VARCHAR(12),
	XREF3 VARCHAR(20),
	SGTXT VARCHAR(50),
	XNEGP VARCHAR(1),
	XARCH VARCHAR(1),
	UMSKS VARCHAR(1),
	UPDMOD VARCHAR(1),
	ZUONR VARCHAR(18),
	AWTYP VARCHAR(5),
	AWKEY VARCHAR(20),
	BSTAT VARCHAR(1),
	DMBTR FLOAT,
	DMBE2 FLOAT,
	DMBE3 FLOAT,
	GJAHR VARCHAR(4),
	HWAE2 VARCHAR(5),
	HWAE3 VARCHAR(5),
	MONAT VARCHAR(2),
	PROJK VARCHAR(8),
	SHKZG VARCHAR(1),
	WRBTR FLOAT
);

create or replace TABLE "0material_attr" (
	MANDT VARCHAR(3),
	MATNR VARCHAR(18),
	ERSDA DATE,
	ERNAM VARCHAR(12),
	LAEDA DATE,
	AENAM VARCHAR(12),
	VPSTA VARCHAR(15),
	PSTAT VARCHAR(15),
	LVORM VARCHAR(1),
	MTART VARCHAR(4),
	MBRSH VARCHAR(1),
	MATKL VARCHAR(9),
	BISMT VARCHAR(18),
	MEINS VARCHAR(3),
	BSTME VARCHAR(3),
	ZEINR VARCHAR(22),
	ZEIAR VARCHAR(3),
	ZEIVR VARCHAR(2),
	ZEIFO VARCHAR(4),
	AESZN VARCHAR(6),
	BLATT VARCHAR(3),
	BLANZ VARCHAR(3),
	FERTH VARCHAR(18),
	FORMT VARCHAR(4),
	GROES VARCHAR(32),
	WRKST VARCHAR(48),
	NORMT VARCHAR(18),
	LABOR VARCHAR(3),
	EKWSL VARCHAR(4),
	BRGEW FLOAT,
	NTGEW FLOAT,
	GEWEI VARCHAR(3),
	VOLUM FLOAT,
	VOLEH VARCHAR(3),
	BEHVO VARCHAR(2),
	RAUBE VARCHAR(2),
	TEMPB VARCHAR(2),
	DISST VARCHAR(3),
	TRAGR VARCHAR(4),
	STOFF VARCHAR(18),
	SPART VARCHAR(2),
	KUNNR VARCHAR(10),
	EANNR VARCHAR(13),
	WESCH FLOAT,
	BWVOR VARCHAR(1),
	BWSCL VARCHAR(1),
	SAISO VARCHAR(4),
	ETIAR VARCHAR(2),
	ETIFO VARCHAR(2),
	ENTAR VARCHAR(1),
	EAN11 VARCHAR(18),
	NUMTP VARCHAR(2),
	LAENG FLOAT,
	BREIT FLOAT,
	HOEHE FLOAT,
	MEABM VARCHAR(3),
	PRDHA VARCHAR(18),
	AEKLK VARCHAR(1),
	CADKZ VARCHAR(1),
	QMPUR VARCHAR(1),
	ERGEW FLOAT,
	ERGEI VARCHAR(3),
	ERVOL FLOAT,
	ERVOE VARCHAR(3),
	GEWTO FLOAT,
	VOLTO FLOAT,
	VABME VARCHAR(1),
	KZREV VARCHAR(1),
	KZKFG VARCHAR(1),
	XCHPF VARCHAR(1),
	VHART VARCHAR(4),
	FUELG FLOAT,
	STFAK NUMBER(38,0),
	MAGRV VARCHAR(4),
	BEGRU VARCHAR(4),
	DATAB DATE,
	LIQDT DATE,
	SAISJ VARCHAR(4),
	PLGTP VARCHAR(2),
	MLGUT VARCHAR(1),
	EXTWG VARCHAR(18),
	SATNR VARCHAR(18),
	ATTYP VARCHAR(2),
	KZKUP VARCHAR(1),
	KZNFM VARCHAR(1),
	PMATA VARCHAR(18),
	MSTAE VARCHAR(2),
	MSTAV VARCHAR(2),
	MSTDE DATE,
	MSTDV DATE,
	TAKLV VARCHAR(1),
	RBNRM VARCHAR(9),
	MHDRZ FLOAT,
	MHDHB FLOAT,
	MHDLP FLOAT,
	INHME VARCHAR(3),
	INHAL FLOAT,
	VPREH FLOAT,
	ETIAG VARCHAR(18),
	INHBR FLOAT,
	CMETH VARCHAR(1),
	CUOBF VARCHAR(18),
	KZUMW VARCHAR(1),
	KOSCH VARCHAR(18),
	SPROF VARCHAR(1),
	NRFHG VARCHAR(1),
	MFRPN VARCHAR(40),
	MFRNR VARCHAR(10),
	BMATN VARCHAR(18),
	MPROF VARCHAR(4),
	KZWSM VARCHAR(1),
	SAITY VARCHAR(2),
	PROFL VARCHAR(3),
	IHIVI VARCHAR(1),
	ILOOS VARCHAR(1),
	SERLV VARCHAR(1),
	KZGVH VARCHAR(1),
	XGCHP VARCHAR(1),
	KZEFF VARCHAR(1),
	COMPL VARCHAR(2),
	IPRKZ VARCHAR(1),
	RDMHD VARCHAR(1),
	PRZUS VARCHAR(1),
	MTPOS_MARA VARCHAR(4),
	BFLME VARCHAR(1),
	NSNID VARCHAR(9),
	COLOR_ATINN VARCHAR(10),
	SIZE1_ATINN VARCHAR(10),
	SIZE2_ATINN VARCHAR(10),
	COLOR VARCHAR(18),
	SIZE1 VARCHAR(18),
	SIZE2 VARCHAR(18),
	FREE_CHAR VARCHAR(18),
	CARE_CODE VARCHAR(16),
	BRAND_ID VARCHAR(4),
	FIBER_CODE1 VARCHAR(3),
	FIBER_PART1 VARCHAR(3),
	FIBER_CODE2 VARCHAR(3),
	FIBER_PART2 VARCHAR(3),
	FIBER_CODE3 VARCHAR(3),
	FIBER_PART3 VARCHAR(3),
	FIBER_CODE4 VARCHAR(3),
	FIBER_PART4 VARCHAR(3),
	FIBER_CODE5 VARCHAR(3),
	FIBER_PART5 VARCHAR(3),
	RPA_WGH1 VARCHAR(18),
	RPA_WGH2 VARCHAR(18),
	RPA_WGH3 VARCHAR(18),
	RPA_WGH4 VARCHAR(18),
	FASHGRD VARCHAR(4),
	ZZDISMM VARCHAR(2)
);

copy into "0customer_attr"
from @SAP_RAW.CSV_FILES/0customer_attr
FILE_FORMAT = (TYPE = CSV);

copy into "0fi_ar_4"
from @SAP_RAW.CSV_FILES/0fi_ar_4
FILE_FORMAT = (TYPE = CSV);

copy into "0material_attr"
from @SAP_RAW.CSV_FILES/0material_attr
FILE_FORMAT = (TYPE = CSV);


---- SOME CLEANUP

-- fill in the business unit BEGRU so that data is not empty
UPDATE "0customer_attr"
SET BEGRU = 
    CASE MOD(ABS(RANDOM()), 5) 
        WHEN 0 THEN 'TECH'  
        WHEN 1 THEN 'FINC'  
        WHEN 2 THEN 'HLTH'  
        WHEN 3 THEN 'RETL'  
        WHEN 4 THEN 'ENRG'  
    END;


-- add into customer attributes the missing customer numbers (KUNNR) from fi_ar_4
INSERT INTO "0customer_attr" (
    MANDT, KUNNR, ADRNR, ANRED, AUFSD, BAHNE, BAHNS, BBBNR, BBSNR, BEGRU, BRSCH, BUBKZ, DATLT, ERDAT, ERNAM, EXABL, 
    FAKSD, FISKN, KNAZK, KNRZA, KONZS, KTOKD, KUKLA, LAND1, LIFNR, LIFSD, LOCCO, LOEVM, NAME1, NAME2, NAME3, NAME4, 
    NIELS, ORT01, ORT02, PFACH, PSTL2, PSTLZ, REGIO, COUNC, CITYC, RPMKR, SORTL, SPERR, SPRAS, STCD1, STCD2, STKZA, 
    STKZU, STRAS, TELBX, TELF1, TELF2, TELFX, TELTX, TELX1, LZONE, XCPDK, XZEMP, VBUND, STCEG, DEAR1, DEAR2, DEAR3, 
    DEAR4, DEAR5, DEAR6, GFORM, BRAN1, BRAN2, BRAN3, BRAN4, BRAN5, EKONT, UMSAT, UMJAH, UWAER, JMZAH, JMJAH, KATR1, 
    KATR2, KATR3, KATR4, KATR5, KATR6, KATR7, KATR8, KATR9, KATR10, STKZN, UMSA1, TXJCD, MCOD1, MCOD2, MCOD3, PERIV, 
    ABRVW, INSPBYDEBI, INSPATDEBI, KTOCD, PFORT, WERKS, DTAMS, DTAWS, DUEFL, HZUOR, SPERZ, ETIKG, CIVVE, MILVE, KDKG1, 
    KDKG2, KDKG3, KDKG4, KDKG5, XKNZA, FITYP, STCDT, STCD3, STCD4, XICMS, XXIPI, XSUBT, CFOPC, TXLW1, TXLW2, CCC01, 
    CCC02, CCC03, CCC04, CASSD, KNURL
)
SELECT 
   distinct 800 AS MANDT,
     A.kunnr AS KUNNR,	
    0000006658 AS ADRNR,
    NULL AS ANRED,
    NULL AS AUFSD,
    NULL AS BAHNE,
    NULL AS BAHNS,
    0000000 AS BBBNR,
    00000 AS BBSNR,	
    'HLTH' AS BEGRU, 
    NULL AS BRSCH,
    0 AS BUBKZ,
    NULL AS DATLT,
    '1995-03-23' AS ERDAT,
    NULL AS ERNAM,
    NULL AS EXABL,
    NULL AS FAKSD,
    NULL AS FISKN,
    NULL AS KNAZK,
    NULL AS KNRZA,
    NULL AS KONZS,
    0006 AS KTOKD,
    NULL AS KUKLA,
    'DE' AS LAND1,
    NULL AS LIFNR,
    NULL AS LIFSD,
    NULL AS LOCCO,
    NULL AS LOEVM,
    'Wett' AS NAME1,
    NULL AS NAME2,
    NULL AS NAME3,
    NULL AS NAME4,
    NULL AS NIELS,
    'Walldorf' AS ORT01,
    NULL AS ORT02,
    NULL AS PFACH,
    NULL AS PSTL2,
    69190 AS PSTLZ,
    08 AS REGIO,
    NULL AS COUNC,
    NULL AS CITYC,
    NULL AS RPMKR,
    'WETT' AS SORTL,
    NULL AS SPERR,
    'D' AS SPRAS,
    NULL AS STCD1,
    NULL AS STCD2,
    NULL AS STKZA,
    NULL AS STKZU,
    'Astorstrasse34' AS STRAS,
    NULL AS TELBX,
    NULL AS TELF1,
    NULL AS TELF2,
    NULL AS TELFX,
    NULL AS TELTX,
    NULL AS TELX1,
    NULL AS LZONE,
    NULL AS XCPDK,
    NULL AS XZEMP,
    NULL AS VBUND,
    NULL AS STCEG,
    'X' AS DEAR1,
    NULL AS DEAR2,
    NULL AS DEAR3,
    NULL AS DEAR4,
    NULL AS DEAR5,
    NULL AS DEAR6,
    NULL AS GFORM,
    NULL AS BRAN1,
    NULL AS BRAN2,
    NULL AS BRAN3,
    NULL AS BRAN4,
    NULL AS BRAN5,
    NULL AS EKONT,
    0 AS UMSAT,
    0000 AS UMJAH,
    NULL AS UWAER,
    000000 AS JMZAH,
    0000 AS JMJAH,
    NULL AS KATR1,
    NULL AS KATR2,
    NULL AS KATR3,
    NULL AS KATR4,
    NULL AS KATR5,
    NULL AS KATR6,
    NULL AS KATR7,
    NULL AS KATR8,
    NULL AS KATR9,
    NULL AS KATR10,
    NULL AS STKZN,
    0 AS UMSA1,
    NULL AS TXJCD,
    'WETT' AS MCOD1,
    NULL AS MCOD2,
    'WALLDORF' AS MCOD3,
    NULL AS PERIV,
    NULL AS ABRVW,
    NULL AS INSPBYDEBI,
    NULL AS INSPATDEBI,
    NULL AS KTOCD,
    NULL AS PFORT,
    NULL AS WERKS,
    NULL AS DTAMS,
    NULL AS DTAWS,
    'X' AS DUEFL,
    00 AS HZUOR,																			
    NULL AS SPERZ,
    NULL AS ETIKG,
    NULL AS CIVVE,
    NULL AS MILVE,
    NULL AS KDKG1,
    NULL AS KDKG2,
    NULL AS KDKG3,
    NULL AS KDKG4,
    NULL AS KDKG5,
    NULL AS XKNZA,
    NULL AS FITYP,
    NULL AS STCDT,
    NULL AS STCD3,
    NULL AS STCD4,
    NULL AS XICMS,
    NULL AS XXIPI,
    NULL AS XSUBT,
    NULL AS CFOPC,
    NULL AS TXLW1,
    NULL AS TXLW2,
    NULL AS CCC01,
    NULL AS CCC02,
    NULL AS CCC03,
    NULL AS CCC04,
    NULL AS CASSD,
    NULL AS KNURL
FROM "0fi_ar_4" A
LEFT JOIN "0customer_attr" B ON A.kunnr = B.kunnr
WHERE B.kunnr IS NULL;


use schema PUBLIC;

CREATE OR REPLACE STAGE STREAMLIT_STAGE
DIRECTORY = (ENABLE = true);

COPY FILES 
    INTO @STREAMLIT_STAGE
    FROM @SAP_LLM_ANALYST2.PUBLIC.GITHUB_REPO_SAP_LLM_ANALYST/branches/main/
    FILES =('SAP_CHAT.py');


ALTER STAGE STREAMLIT_STAGE REFRESH;

CREATE OR REPLACE STREAMLIT SAP_CHAT
    ROOT_LOCATION = '@STREAMLIT_STAGE'
    MAIN_FILE = 'SAP_CHAT.py'
    TITLE = 'SAP CHATBOT'
    QUERY_WAREHOUSE = 'COMPUTE_WH';  